<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù…Ø¯Ù‰ Ø¯Ù„ÙŠÙØ±ÙŠ - Ø¯Ø¬Ø§Ø¬ Ø¨ÙˆØ±Ø¯Ùˆ</title>
<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- OpenStreetMap Nominatim API -->
<script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

<style>
:root{
  --green:#28a745;
  --green-dark:#1d7a33;
  --bg:#f6fbf7;
  --card:#ffffff;
  --muted:#6b7280;
  --blue:#007bff;
  --blue-dark:#0056b3;
  --yellow:#ffc107;
  --orange:#fd7e14;
  --red:#dc3545;
  font-family: "Segoe UI", Tahoma, Arial;
}
body{margin:0;background:var(--bg);direction:rtl;padding:0;padding-bottom:70px;}

/* PRELOADER STYLES */
#preloader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    transition: opacity 0.5s ease;
}
#preloader img {
    width: 200px;
    height: auto;
    border-radius: 12px;
}
.loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--green);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin-top: 20px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* LANDING PAGE STYLES */
#landingPage {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg);
    z-index: 9998;
    display: none;
    display: grid; 
    place-items: center;
    padding: 20px;
    box-sizing: border-box;
}

.landing-content {
    background: var(--card);
    padding: 30px 25px;
    border-radius: 16px;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    text-align: center;
    margin: auto;
    box-sizing: border-box;
}

.landing-content h2 {
    color: var(--green-dark);
    margin-bottom: 15px;
    font-size: 1.4rem;
}

.landing-form-group {
    margin-bottom: 18px;
    text-align: right;
}

.landing-form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

.landing-form-group input, .landing-form-group select {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-family: inherit;
    font-size: 15px;
    direction: rtl;
    text-align: right;
    height: 48px;
    transition: border-color 0.3s ease;
}

.landing-form-group input:focus, .landing-form-group select:focus {
    outline: none;
    border-color: var(--green);
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
}

.landing-form-group .phone-input{
  direction:ltr;
  text-align:left;
}

.landing-btn-group {
    display: flex;
    gap: 10px;
    justify-content: space-between;
    margin-top: 15px;
}

.landing-btn-group .btn {
    flex: 1;
    font-size: 15px;
    padding: 12px 8px;
    height: 48px;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.primary-btn {
    background: var(--green);
    color: white;
}

.primary-btn:hover {
    background: var(--green-dark);
}

.secondary-btn {
    background: #f0f0f0;
    color: #333;
    border: 1px solid #ddd;
}

.secondary-btn:hover {
    background: #e0e0e0;
}

#landingPage p {
    color: var(--muted);
    margin-bottom: 25px;
    font-size: 14px;
    line-height: 1.5;
}

/* HEADER */
header{
  display:flex;
  flex-direction: column;
  padding:14px 20px 0;
  background:linear-gradient(90deg,var(--green-dark),var(--green));
  color:white;
  box-shadow:0 4px 12px rgba(0,0,0,0.12);
  position:sticky;
  top:0;
  z-index:40;
}
.header-top{
  display: flex;
  align-items: center;
  gap: 12px;
  padding-bottom: 14px;
}
.logo{
  width:46px;
  height:46px;
  border-radius:12px;
  background:#ffffff22;
  display:grid;
  place-items:center;
  font-weight:800;
  font-size:20px;
}

/* MAIN */
main{padding:16px;max-width:1100px;margin:auto}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:14px;
}
.card{
  background:var(--card);
  padding:12px;
  border-radius:14px;
  box-shadow:0 5px 14px rgba(0,0,0,0.06);
  transition: transform 0.3s ease;
  position: relative;
}
.card:hover {
  transform: translateY(-5px);
}
.thumb{
  height:120px;
  border-radius:10px;
  background:#e8fbee;
  display:flex;
  align-items:center;
  justify-content:center;
  color:var(--green-dark);
  font-size:20px;
  margin-bottom:8px;
  overflow: hidden;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.title{
  font-weight:700;
  margin-bottom: 4px;
}
.desc{
  font-size:13px;
  color:var(--muted);
  margin-bottom: 8px;
}
.price{
  font-weight:700;
  color:var(--green-dark);
  font-size: 16px;
}
.btn{
  background:var(--green);
  color:white;
  border:0;
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  margin-top:8px;
  width:100%;
  transition: background 0.3s ease;
}
.btn:hover {
  background:var(--green-dark);
}
.out-of-stock-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 14px;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
    pointer-events: none;
    z-index: 5;
}

/* SEARCH AND SELECT */
.search-and-select-container {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}

.delivery-area-select-box {
    width: 45%;
    flex-shrink: 0;
}
.delivery-area-select-box.hidden {
  display: none;
}

.delivery-area-select-box select {
    width: 100%;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid #ffffff55;
    background: #ffffff22;
    color: white;
    box-sizing: border-box;
    font-family: inherit;
    font-size: 13px;
    margin: 0;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="%23ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
    background-repeat: no-repeat;
    background-position: left 10px center;
    padding-left: 30px;
}

.delivery-area-select-box select option {
    background: var(--green-dark);
    color: white;
}

.search-box {
    width: 55%;
    flex-grow: 1;
}

.search-box.full-width {
    width: 100%;
}

.search-box input{
  margin-bottom:0;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:14px;
  width: 100%;
  background: white;
  color: #333;
}

/* CATEGORIES STYLES */
.categories-container{
  display:flex;
  gap:8px;
  overflow-x:auto;
  padding-bottom:14px;
  margin-bottom:0;
}
.category-chip{
  padding:8px 16px;
  border-radius:20px;
  cursor:pointer;
  white-space:nowrap;
  font-weight:600;
  font-size:14px;
  background:#ffffff33;
  color:white;
  border:1px solid #ffffff66;
  transition:0.2s;
}
.category-chip.active, .category-chip:hover{
  background:var(--card);
  color:var(--green-dark);
  border-color:var(--card);
}

/* BOTTOM NAV BAR */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: white;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 8px 0;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    z-index: 100;
    border-top: 1px solid #eee;
}
.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 12px;
    transition: all 0.3s ease;
    color: var(--muted);
    flex: 1;
    max-width: 100px;
    position: relative;
}
.nav-item.active {
    color: var(--green);
    background: rgba(40, 167, 69, 0.1);
}
.nav-item svg {
    width: 24px;
    height: 24px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
}
.nav-item span {
    font-size: 12px;
    font-weight: 600;
}

/* Cart Badge */
.cart-badge {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(10px);
    background: var(--red);
    color: white;
    font-size: 10px;
    font-weight: bold;
    min-width: 18px;
    height: 18px;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    animation: badgePop 0.3s ease;
}

@keyframes badgePop {
    0% { transform: translateX(10px) scale(0); }
    50% { transform: translateX(10px) scale(1.2); }
    100% { transform: translateX(10px) scale(1); }
}

/* CART BOTTOM SHEET */
.cart-sheet{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:white;
  overflow:auto;
  z-index:200;
  transition:transform 0.35s ease;
  transform:translateY(100%);
  display:flex;
  flex-direction:column;
}
.cart-sheet.open{
  transform:translateY(0);
}
.cart-header{
  padding:16px;
  background:linear-gradient(90deg,var(--green-dark),var(--green));
  color:white;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}
.cart-body{
  padding:16px;
  flex:1;
  overflow-y:auto;
}
.cart-footer{
  padding:16px;
  background:#f8f9fa;
  border-top:1px solid #dee2e6;
  position:sticky;
  bottom:0;
}
.cart-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 0;
  border-bottom:1px solid #eee;
}
.qty-btn{
  padding:6px 12px;
  border:1px solid #ccc;
  border-radius:8px;
  cursor:pointer;
  margin:0 4px;
  background:#f8f9fa;
  transition: all 0.2s ease;
}
.qty-btn:hover {
  background: #e9ecef;
}

.total-box{
  background:#f2fff4;
  padding:12px;
  border-radius:10px;
  margin:12px 0;
  display:flex;
  justify-content:space-between;
  font-weight:bold;
}

/* ORDER OPTIONS */
.option-box{
  margin-top:10px;
  padding:12px;
  background:#f9fff9;
  border-radius:12px;
  border:1px solid #d9f3dc;
}
.form-group{
  margin-bottom:16px;
}
.form-group label{
  display:block;
  margin-bottom:6px;
  font-weight:600;
}
select,input,textarea{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  box-sizing:border-box;
  font-family:inherit;
  font-size:15px;
}
.phone-input{
  direction:ltr;
  text-align:left;
}

/* MAP MODAL */
.map-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.map-modal-content {
    background: white;
    width: 90%;
    height: 80%;
    border-radius: 20px;
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
}
.map-modal-header {
    padding: 15px;
    background: var(--green);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.map-modal-header h3 {
    margin: 0;
}
.close-map-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
}
#map {
    flex: 1;
    width: 100%;
    height: 100%;
    z-index: 1;
}
.map-actions {
    padding: 15px;
    background: white;
    display: flex;
    gap: 10px;
}
.confirm-location-btn {
    flex: 1;
    padding: 12px;
    background: var(--green);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
}
.confirm-location-btn:hover {
    background: var(--green-dark);
}
.cancel-location-btn {
    flex: 1;
    padding: 12px;
    background: #f0f0f0;
    color: #333;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
}

/* LOCATION PICKER */
.location-picker {
    background: #f0f9ff;
    border: 2px dashed var(--blue);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.location-picker:hover {
    background: #e3f2fd;
}
.location-picker.selected {
    background: #e8f5e9;
    border-color: var(--green);
}
.location-picker-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
.location-picker-header svg {
    width: 24px;
    height: 24px;
    stroke: var(--blue);
}
.location-coords {
    font-family: monospace;
    font-size: 13px;
    color: var(--muted);
    direction: ltr;
    text-align: left;
    background: white;
    padding: 8px;
    border-radius: 6px;
    margin-top: 8px;
    word-break: break-all;
}
.location-address {
    font-size: 14px;
    color: #333;
    margin-top: 8px;
    padding: 8px;
    background: white;
    border-radius: 6px;
    border-right: 3px solid var(--green);
}
.get-location-btn {
    background: var(--blue);
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    width: 100%;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
    margin-top: 10px;
}
.get-location-btn:hover {
    background: var(--blue-dark);
}
.get-location-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.open-map-btn {
    background: var(--green);
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    width: 100%;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.open-map-btn:hover {
    background: var(--green-dark);
}
.open-map-btn svg {
    width: 20px;
    height: 20px;
    stroke: white;
}

/* CLOSE BUTTON */
.close-btn{
  background:none;
  border:none;
  color:white;
  font-size:24px;
  cursor:pointer;
  padding:0;
  width:30px;
  height:30px;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* HIDDEN FORM */
.hidden-form {
  display: none;
}

/* SUCCESS MESSAGE */
.success-message {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 300;
  justify-content: center;
  align-items: center;
}
.success-content {
  background: white;
  padding: 30px;
  border-radius: 15px;
  text-align: center;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.success-icon {
  font-size: 60px;
  color: var(--green);
  margin-bottom: 20px;
}

/* MY ORDERS PAGE */
.orders-page {
    padding: 16px;
    max-width: 600px;
    margin: 0 auto;
    padding-bottom: 80px;
}
.order-card {
    background: white;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-right: 4px solid;
}
.order-card.pending {
    border-color: var(--yellow);
}
.order-card.preparing {
    border-color: var(--orange);
}
.order-card.delivering {
    border-color: var(--blue);
}
.order-card.nearby {
    border-color: var(--green);
}
.order-card.delivered {
    border-color: var(--green-dark);
}
.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
    gap: 8px;
}
.order-id {
    font-weight: bold;
    color: var(--green-dark);
    background: #e8f5e9;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 13px;
}
.order-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}
.status-pending {
    background: #fff3cd;
    color: #856404;
}
.status-preparing {
    background: #ffe5d0;
    color: #fd7e14;
}
.status-delivering {
    background: #cce5ff;
    color: #004085;
}
.status-nearby {
    background: #d4edda;
    color: #155724;
}
.status-delivered {
    background: #d4edda;
    color: #155724;
}
.order-items {
    margin: 10px 0;
    font-size: 14px;
    color: #666;
    max-height: 60px;
    overflow-y: auto;
}
.order-total {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}
.tracking-bar {
    display: flex;
    justify-content: space-between;
    margin: 20px 0 10px;
    position: relative;
}
.tracking-step {
    flex: 1;
    text-align: center;
    font-size: 10px;
    color: #999;
    position: relative;
    z-index: 2;
}
.tracking-step.active {
    color: var(--green);
    font-weight: 600;
}
.tracking-step.active .step-dot {
    background: var(--green);
    border-color: var(--green);
}
.step-dot {
    width: 10px;
    height: 10px;
    background: #ddd;
    border: 2px solid #ddd;
    border-radius: 50%;
    margin: 0 auto 5px;
}
.tracking-line {
    position: absolute;
    top: 6px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: #ddd;
    z-index: 1;
}
.tracking-line-fill {
    height: 2px;
    background: var(--green);
    width: 0%;
    transition: width 0.3s ease;
}

@media (max-width: 480px) {
    #landingPage {
        padding: 15px;
    }
    .landing-content {
        padding: 25px 20px;
        max-width: 100%;
        margin: 0;
        border-radius: 14px;
    }
    .landing-content h2 {
        font-size: 1.3rem;
        margin-bottom: 12px;
    }
    .landing-form-group input, .landing-form-group select {
        padding: 10px 12px;
        height: 46px;
        font-size: 14px;
    }
    .landing-btn-group .btn {
        height: 46px;
        font-size: 14px;
        padding: 10px 6px;
    }
    .landing-form-group {
        margin-bottom: 16px;
    }
    .tracking-step span {
        font-size: 9px;
    }
}

@media (max-width: 768px) and (min-width: 481px) {
    .landing-content {
        max-width: 450px;
        padding: 35px 30px;
    }
}

/* Leaflet custom styles */
.leaflet-container {
    font-family: inherit;
}
.leaflet-control-attribution {
    font-size: 8px;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>

<div id="preloader">
    <img src="https://www2.0zz0.com/2025/12/09/18/567526201.png" alt="Logo">
    <div class="loader"></div>
</div>

<div id="landingPage">
    <div class="landing-content">
        <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯Ø¬Ø§Ø¬ Ø¨ÙˆØ±Ø¯Ùˆ</h2>
        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ ÙˆØ§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø·Ù„Ø¨.</p>

        <div class="landing-form-group">
            <label for="landingPhoneNumber">Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</label>
            <input type="tel" id="landingPhoneNumber" class="phone-input" 
                   placeholder="Ù…Ø«Ø§Ù„: 0912345678" 
                   maxlength="10">
        </div>
        
        <div class="landing-form-group">
            <label for="landingAreaSelect">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</label>
            <select id="landingAreaSelect">
                </select>
        </div>
        
        <div class="landing-btn-group">
            <button class="btn primary-btn" id="startOrdering">Ø¨Ø¯Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
            <button class="btn secondary-btn" id="browseMenu">ØªØµÙØ­ Ø§Ù„Ù…Ù†ÙŠÙˆ</button>
        </div>
    </div>
</div>

<header id="mainHeader" style="display: none;">
    <div class="header-top">
      <div style="font-size:17px;font-weight:700">Ø¯Ø¬Ø§Ø¬ Ø¨ÙˆØ±Ø¯Ùˆ</div>
      <div style="font-size:13px;opacity:.9">Ù…Ø¯Ù‰ Ø¯Ù„ÙŠÙØ±ÙŠ</div>
    </div>

    <div class="search-and-select-container">
        <div class="delivery-area-select-box" id="areaSelectBox">
            <select id="headerAreaSelect">
                </select>
        </div>
        
        <div class="search-box" id="searchBoxContainer">
            <input type="text" id="searchBar" placeholder="Ø¨Ø­Ø« ..." onkeyup="filterProducts()">
        </div>
    </div>
    
    <div class="categories-container" id="categoriesContainer">
    </div>
</header>

<main id="mainContent" style="display: none;">
    <div class="grid" id="products"></div>
</main>

<main id="ordersContent" style="display: none;" class="orders-page">
    <h2 style="color: var(--green-dark); margin-bottom: 20px;">Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
    <div id="ordersList"></div>
</main>

<!-- Bottom Navigation Bar -->
<div class="bottom-nav" id="bottomNav" style="display: none;">
    <div class="nav-item" id="navMenu" onclick="showMenu()">
        <svg viewBox="0 0 24 24">
            <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
        <span>Ø§Ù„Ù…Ù†ÙŠÙˆ</span>
    </div>
    <div class="nav-item" id="navCart" onclick="openCart()">
        <svg viewBox="0 0 24 24">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.7 13.4a2 2 0 0 0 2 1.6h9.7a2 2 0 0 0 2-1.6L23 6H6"/>
        </svg>
        <span>Ø§Ù„Ø³Ù„Ø©</span>
        <div class="cart-badge" id="cartBadge" style="display: none;">0</div>
    </div>
    <div class="nav-item" id="navOrders" onclick="showOrders()">
        <svg viewBox="0 0 24 24">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
            <line x1="3" y1="6" x2="21" y2="6"/>
            <path d="M16 10a4 4 0 0 1-8 0"/>
        </svg>
        <span>Ø·Ù„Ø¨Ø§ØªÙŠ</span>
    </div>
</div>

<!-- Map Modal -->
<div class="map-modal" id="mapModal">
    <div class="map-modal-content">
        <div class="map-modal-header">
            <h3>Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>
            <button class="close-map-btn" onclick="closeMapModal()">Ã—</button>
        </div>
        <div id="map"></div>
        <div class="map-actions">
            <button class="cancel-location-btn" onclick="closeMapModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="confirm-location-btn" onclick="confirmMapLocation()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        </div>
    </div>
</div>

<div class="cart-sheet" id="cartSheet">
    <div class="cart-header">
        <h3 style="margin:0">Ø§Ù„Ø³Ù„Ø©</h3>
        <button class="close-btn" id="closeCartSheet">Ã—</button>
    </div>
  
    <div class="cart-body">
        <div id="cartItems"></div>

        <!-- Location Picker with Map -->
        <div class="location-picker" id="locationPicker">
            <div class="location-picker-header">
                <svg viewBox="0 0 24 24">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span style="font-weight: 600;">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
            </div>
            <div id="locationStatus" style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">
                Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¯Ù‚ÙŠÙ‚
            </div>
            <div id="locationAddress" class="location-address" style="display: none;"></div>
            <div id="locationCoords" class="location-coords" style="display: none;"></div>
            <button class="get-location-btn" id="getLocationBtn" onclick="getCurrentLocation()">
                ğŸ“ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            </button>
            <button class="open-map-btn" id="openMapBtn" onclick="openMapModal()">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path d="M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4z"/>
                    <path d="M8 2v16M16 6v16"/>
                </svg>
                ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹
            </button>
        </div>

        <div class="total-box">
            <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</div>
            <div id="subtotal">0.00 Ø¯ÙŠÙ†Ø§Ø±</div>
        </div>
    
        <div class="total-box" id="deliveryPriceBox" style="display:none; background:#f2fff4">
            <div>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</div>
            <div id="deliveryPrice" style="color:var(--green-dark)">0.00 Ø¯ÙŠÙ†Ø§Ø±</div>
        </div>

        <div class="option-box">
            <div class="form-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨</label>
                <textarea id="orderNotes" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø±ÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ø·Ø§ Ø¨Ø¯ÙˆÙ† Ù…Ù„Ø­ØŒ Ø£Ùˆ ØªÙˆØµÙŠÙ„ Ù„Ù„Ø¨Ø§Ø¨ Ø±Ù‚Ù… 5"></textarea>
            </div>
      
            <div class="form-group">
                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø·Ù„Ø¨</label>
                <select id="orderType">
                    <option value="delivery">ØªÙˆØµÙŠÙ„</option>
                    <option value="take">Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ù…Ø·Ø¹Ù…</option>
                </select>
            </div>
      
            <div class="form-group">
                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                <select id="paymentType"></select>
            </div>

            <div class="total-box" style="margin-top:16px">
                <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                <div id="finalTotal">0.00 Ø¯ÙŠÙ†Ø§Ø±</div>
            </div>
        </div>
    </div>
  
    <div class="cart-footer">
        <button class="btn" id="placeOrder" style="font-size:16px;padding:12px">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
    </div>
</div>

<div class="success-message" id="successMessage">
    <div class="success-content">
        <div class="success-icon">âœ“</div>
        <h3 style="color: var(--green-dark); margin-bottom: 10px;">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h3>
        <p style="color: var(--muted); margin-bottom: 20px;">ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† ØµÙØ­Ø© "Ø·Ù„Ø¨Ø§ØªÙŠ"</p>
        <button class="btn" onclick="closeSuccessMessage()" style="width: auto; padding: 10px 30px;">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
</div>

<script>
/* ===== Firebase Configuration ===== */
const firebaseConfig = {
    apiKey: "AIzaSyAqK9mQsa4o4BIRzTiSl4npwB0liupganA",
    authDomain: "caden-libya.firebaseapp.com",
    databaseURL: "https://caden-libya-default-rtdb.firebaseio.com",
    projectId: "caden-libya",
    storageBucket: "caden-libya.firebasestorage.app",
    messagingSenderId: "111568715581",
    appId: "1:111568715581:web:467d04a4f7d8880dee8f54"
}; 

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===== Global Constants ===== */
const UNIFIED_IMAGE = "https://up6.cc/2025/10/176460585993361.jpg";
const RESTAURANT_WHATSAPP = "218919593444";

/* ===== Global State ===== */
let cart = {};
let allProducts = {};
let allCategories = ["Ø§Ù„ÙƒÙ„"];
let allAreas = {};
let allPaymentMethods = {};
let activeCategory = "Ø§Ù„ÙƒÙ„";
let userArea = "";
let userPhone = "";
let isBrowseMode = false;
let productOrder = [];
let selectedLocation = null;
let map = null;
let marker = null;
let geocoder = null;

/* ===== Load Firebase Data ===== */
function loadData() {
    db.ref('products').on('value', snapshot => {
        allProducts = snapshot.val() || {};
        const productsArray = Object.keys(allProducts).map(key => {
            return { id: key, ...allProducts[key] };
        });
        
        db.ref('productOrder').on('value', orderSnapshot => {
            productOrder = orderSnapshot.val() || [];
            const categoriesSet = new Set();
            productsArray.forEach(p => {
                if (p.category) categoriesSet.add(p.category);
            });
            allCategories = ["Ø§Ù„ÙƒÙ„", ...categoriesSet];
            renderCategories();
            renderProducts();
        });
    });

    db.ref('deliveryAreas').on('value', snapshot => {
        allAreas = snapshot.val() || {};
        initLandingAreaSelect();
        initHeaderAreaSelect();
    });
    
    db.ref('paymentMethods').on('value', snapshot => {
        allPaymentMethods = snapshot.val() || {};
        renderPaymentOptions();
    });
}

/* ===== Payment Options ===== */
function renderPaymentOptions() {
    const paymentSelect = document.getElementById("paymentType");
    paymentSelect.innerHTML = '';

    Object.keys(allPaymentMethods).forEach(methodKey => {
        const method = allPaymentMethods[methodKey];
        const option = document.createElement("option");
        option.value = method.name;
        option.textContent = method.name;
        paymentSelect.appendChild(option);
    });
    
    if (Object.keys(allPaymentMethods).length === 0) {
        const option = document.createElement("option");
        option.value = "ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
        option.textContent = "ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø§ÙØªØ±Ø§Ø¶ÙŠ)";
        paymentSelect.appendChild(option);
    }
}

/* ===== Leaflet Map Initialization ===== */
function initMap() {
    map = L.map('map').setView([32.8872, 13.1913], 8);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
    }).addTo(map);

    geocoder = L.Control.Geocoder.nominatim();

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const pos = [position.coords.latitude, position.coords.longitude];
                map.setView(pos, 15);
            },
            () => {
                console.log('Geolocation failed, using default center');
            }
        );
    }

    map.on('click', (e) => {
        placeMarker(e.latlng);
    });
}

function placeMarker(latlng) {
    if (marker) {
        map.removeLayer(marker);
    }
    
    marker = L.marker(latlng, {
        draggable: true,
        title: 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„'
    }).addTo(map);
    
    marker.on('dragend', (e) => {
        const pos = e.target.getLatLng();
        updateLocationFromCoords(pos.lat, pos.lng);
    });

    updateLocationFromCoords(latlng.lat, latlng.lng);
}

function updateLocationFromCoords(lat, lng) {
    selectedLocation = { lat, lng };
    
    document.getElementById('locationCoords').style.display = 'block';
    document.getElementById('locationCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`)
        .then(response => response.json())
        .then(data => {
            const address = data.display_name || 'Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            document.getElementById('locationAddress').style.display = 'block';
            document.getElementById('locationAddress').textContent = address;
        })
        .catch(error => {
            console.error('Error getting address:', error);
            document.getElementById('locationAddress').style.display = 'block';
            document.getElementById('locationAddress').textContent = 'Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        });

    document.getElementById('locationStatus').innerHTML = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­';
    document.getElementById('locationPicker').classList.add('selected');
}

/* ===== Map Modal Functions ===== */
function openMapModal() {
    document.getElementById('mapModal').style.display = 'flex';
    
    setTimeout(() => {
        if (!map) {
            initMap();
        } else {
            map.invalidateSize();
            if (selectedLocation) {
                map.setView([selectedLocation.lat, selectedLocation.lng], 15);
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker([selectedLocation.lat, selectedLocation.lng], {
                    draggable: true
                }).addTo(map);
                
                marker.on('dragend', (e) => {
                    const pos = e.target.getLatLng();
                    updateLocationFromCoords(pos.lat, pos.lng);
                });
            }
        }
    }, 100);
}

function closeMapModal() {
    document.getElementById('mapModal').style.display = 'none';
}

function confirmMapLocation() {
    if (marker) {
        const pos = marker.getLatLng();
        updateLocationFromCoords(pos.lat, pos.lng);
    }
    closeMapModal();
}

/* ===== Location Functions ===== */
function getCurrentLocation() {
    if (!navigator.geolocation) {
        alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
        return;
    }

    const locationBtn = document.getElementById('getLocationBtn');
    locationBtn.disabled = true;
    locationBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹...';

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            selectedLocation = pos;
            
            document.getElementById('locationCoords').style.display = 'block';
            document.getElementById('locationCoords').textContent = `${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}`;
            
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lng}&accept-language=ar`)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name || 'Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    document.getElementById('locationAddress').style.display = 'block';
                    document.getElementById('locationAddress').textContent = address;
                })
                .catch(error => {
                    console.error('Error getting address:', error);
                    document.getElementById('locationAddress').style.display = 'block';
                    document.getElementById('locationAddress').textContent = 'Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                });

            document.getElementById('locationStatus').innerHTML = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­';
            document.getElementById('locationPicker').classList.add('selected');
            
            locationBtn.disabled = false;
            locationBtn.textContent = 'ğŸ“ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹';
        },
        (error) => {
            let errorMessage = 'ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                    break;
            }
            document.getElementById('locationStatus').innerHTML = `âŒ ${errorMessage}`;
            locationBtn.disabled = false;
            locationBtn.textContent = 'ğŸ“ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
        }
    );
}

/* ===== Preloader & Landing Page ===== */
window.onload = function() {
    loadData();
    
    const savedPhone = localStorage.getItem('userPhone');
    const savedArea = localStorage.getItem('userArea');
    if (savedPhone) {
        document.getElementById('landingPhoneNumber').value = savedPhone;
    }
    if (savedArea) {
        userArea = savedArea; 
    }
    
    document.getElementById('preloader').style.opacity = '0';
    setTimeout(() => {
        document.getElementById('preloader').style.display = 'none';
        document.getElementById('landingPage').style.display = 'grid';
        history.pushState({ page: 'landing' }, 'Ø¯Ø¬Ø§Ø¬ Ø¨ÙˆØ±Ø¯Ùˆ - Ø¨Ø¯Ø¡ Ø§Ù„Ø·Ù„Ø¨');
    }, 500);
};

function initLandingAreaSelect() {
    const landingAreaSelect = document.getElementById("landingAreaSelect");
    const currentSelectedArea = userArea || landingAreaSelect.value; 
    landingAreaSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</option>';
    
    Object.keys(allAreas).forEach(areaKey => {
        const area = allAreas[areaKey];
        const option = document.createElement("option");
        option.value = area.name;
        option.textContent = area.name;
        landingAreaSelect.appendChild(option);
    });
    
    if (currentSelectedArea) {
        landingAreaSelect.value = currentSelectedArea;
    }
}

document.getElementById("startOrdering").onclick = function() {
    const landingAreaSelect = document.getElementById("landingAreaSelect");
    const landingPhoneNumberInput = document.getElementById("landingPhoneNumber");
    
    const area = landingAreaSelect.value;
    const phone = landingPhoneNumberInput.value.trim();

    if (!area) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„.");
        landingAreaSelect.focus();
        return;
    }
    if (!phone || phone.length < 10) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ Ù…ÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù….");
        landingPhoneNumberInput.focus();
        return;
    }

    userArea = area;
    userPhone = phone;
    isBrowseMode = false;
    
    localStorage.setItem('userPhone', userPhone);
    localStorage.setItem('userArea', userArea);

    enterMainApp(false); 
};

document.getElementById("browseMenu").onclick = function() {
    userArea = ""; 
    userPhone = "";
    isBrowseMode = true;
    enterMainApp(true); 
};

function enterMainApp(browseMode = false) {
    document.getElementById('landingPage').style.display = 'none';
    document.getElementById('mainHeader').style.display = 'flex';
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('bottomNav').style.display = 'flex';
    document.getElementById('ordersContent').style.display = 'none';

    const areaSelectBox = document.getElementById('areaSelectBox');
    const searchBoxContainer = document.getElementById('searchBoxContainer');
    
    if (browseMode) {
        areaSelectBox.classList.add('hidden');
        searchBoxContainer.classList.add('full-width');
        history.pushState({ page: 'browse' }, 'Ø¯Ø¬Ø§Ø¬ Ø¨ÙˆØ±Ø¯Ùˆ - ØªØµÙØ­ Ø§Ù„Ù…Ù†ÙŠÙˆ');
    } else {
        areaSelectBox.classList.remove('hidden');
        searchBoxContainer.classList.remove('full-width');
        history.pushState({ page: 'order' }, 'Ø¯Ø¬Ø§Ø¬ Ø¨ÙˆØ±Ø¯Ùˆ - Ø§Ù„Ø·Ù„Ø¨');
    }

    initHeaderAreaSelect();
    renderProducts();
    renderCategories();
    renderCart();
    renderPaymentOptions();
    setActiveNav('menu');
}

/* ===== Header Area Select ===== */
function initHeaderAreaSelect() {
    const headerAreaSelect = document.getElementById("headerAreaSelect");
    headerAreaSelect.innerHTML = "";

    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©";
    headerAreaSelect.appendChild(defaultOption);

    Object.values(allAreas).forEach(area => {
        const option = document.createElement("option");
        option.value = area.name;
        option.textContent = area.name;
        headerAreaSelect.appendChild(option);
    });

    if (userArea) {
        headerAreaSelect.value = userArea;
    }
    
    headerAreaSelect.onchange = updateTotal;
}

/* ===== Products & Categories ===== */
function renderProducts(searchQuery = ""){
    const box = document.getElementById("products");
    box.innerHTML = "";
    const query = searchQuery.toLowerCase();

    let productsArray = Object.keys(allProducts).map(key => {
        return { id: key, ...allProducts[key] };
    }).filter(p => p && p.name && p.category && p.price);

    if (productOrder && productOrder.length > 0) {
        const orderMap = {};
        productOrder.forEach((id, index) => {
            orderMap[id] = index;
        });
        
        productsArray.sort((a, b) => {
            const orderA = orderMap[a.id] !== undefined ? orderMap[a.id] : Infinity;
            const orderB = orderMap[b.id] !== undefined ? orderMap[b.id] : Infinity;
            return orderA - orderB;
        });
    }

    const filteredProducts = productsArray.filter(p => {
        const matchesSearch = p.name.toLowerCase().includes(query) || (p.desc || '').toLowerCase().includes(query);
        const matchesCategory = activeCategory === "Ø§Ù„ÙƒÙ„" || p.category === activeCategory;
        return matchesSearch && matchesCategory;
    });

    if(filteredProducts.length === 0){
        box.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø­Ø¯Ø¯.</p>';
        return;
    }

    filteredProducts.forEach(p=>{
        const isOutOfStock = p.outOfStock;
        box.innerHTML += `
            <div class="card" ${isOutOfStock ? 'style="opacity:0.6; pointer-events:none;"' : ''}>
                <div class="thumb">
                    <img src="${p.image || UNIFIED_IMAGE}" alt="${p.name}" loading="lazy">
                </div>
                <div class="title">${p.name}</div>
                <div class="desc">${p.desc || ''}</div>
                <div class="price">${p.price}.00 Ø¯ÙŠÙ†Ø§Ø±</div>
                <button class="btn" onclick="addToCart('${p.id}')" ${isOutOfStock ? 'disabled' : ''}>${isBrowseMode ? 'Ø§Ø¶ØºØ· Ù„Ù„Ø·Ù„Ø¨' : 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©'}</button>
                ${isOutOfStock ? '<div class="out-of-stock-overlay">Ù†ÙØ¯Øª Ø§Ù„ÙƒÙ…ÙŠØ©</div>' : ''}
            </div>
        `;
    });
}

function filterProducts(){
    const searchQuery = document.getElementById("searchBar").value;
    renderProducts(searchQuery);
}

function renderCategories(){
    const container = document.getElementById("categoriesContainer");
    container.innerHTML = "";

    allCategories.forEach(cat => {
        const isActive = cat === activeCategory ? "active" : "";
        container.innerHTML += `
            <div class="category-chip ${isActive}" onclick="setCategory('${cat}')">
                ${cat}
            </div>
        `;
    });
}

function setCategory(category){
    activeCategory = category;
    renderCategories();
    filterProducts();
}

/* ===== Cart Logic ===== */
function addToCart(id){
    if (isBrowseMode) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ ÙˆÙ…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø·Ù„Ø¨.");
        history.back(); 
        return;
    }

    const p = allProducts[id];
    if(!p || p.outOfStock) return;

    if(!cart[id]) cart[id] = {...p, id: id, qty: 0};
    cart[id].qty++;
    renderCart();
}

function changeQty(id,amount){
    if(!cart[id]) return;
    cart[id].qty += amount;
    if(cart[id].qty<=0) delete cart[id];
    renderCart();
}

function renderCart(){
    const items = document.getElementById("cartItems");
    items.innerHTML = "";

    let subtotal = 0;

    if(Object.keys(cart).length === 0){
        items.innerHTML = `
            <div style="text-align:center;padding:40px 20px;color:var(--muted)">
                <div style="font-size:24px;margin-bottom:10px">ğŸ›’</div>
                <div style="font-size:16px">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>
                <div style="font-size:14px;margin-top:8px">Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
            </div>
        `;
    } else {
        Object.values(cart).forEach(it=>{
            subtotal += it.price * it.qty;
            items.innerHTML += `
                <div class="cart-item">
                    <div style="flex:1">
                        <strong>${it.name}</strong><br>
                        <span style="font-size:14px;color:var(--muted)">${it.price}.00 Ø¯ÙŠÙ†Ø§Ø± Ã— ${it.qty}</span>
                    </div>
                    <div>
                        <button class="qty-btn" onclick="changeQty('${it.id}',1)">+</button>
                        <span style="padding:0 8px;font-weight:bold">${it.qty}</span>
                        <button class="qty-btn" onclick="changeQty('${it.id}',-1)">-</button>
                    </div>
                </div>
            `;
        });
    }

    document.getElementById("subtotal").textContent = subtotal.toFixed(2) + " Ø¯ÙŠÙ†Ø§Ø±";
    updateTotal();

    const count = Object.values(cart).reduce((s,i)=>s+i.qty,0);
    updateCartBadge(count);
}

function updateCartBadge(count) {
    const badge = document.getElementById('cartBadge');
    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

function openCart() {
    document.getElementById("cartSheet").classList.add("open");
    setActiveNav('cart');
}

/* ===== Cart Sheet Toggle ===== */
document.getElementById("closeCartSheet").onclick = ()=>{
    document.getElementById("cartSheet").classList.remove("open");
};

document.getElementById("cartSheet").addEventListener('click', function(e) {
    if(e.target.id === 'cartSheet') {
        this.classList.remove('open');
    }
});

/* ===== Order Type + Delivery ===== */
document.getElementById("orderType").onchange = updateTotal;
document.getElementById("paymentType").onchange = updateTotal;

function updateTotal(){
    let subtotal = 0;
    Object.values(cart).forEach(i=> subtotal += i.price * i.qty);
  
    function getDeliveryPrice(areaName) {
        const area = Object.values(allAreas).find(a => a.name === areaName);
        return area ? area.price : 0;
    }

    const type = document.getElementById("orderType").value;
    const area = document.getElementById("headerAreaSelect").value; 
    let delivery = 0;

    if(type==="delivery" && area){
        delivery = getDeliveryPrice(area) || 0;
        document.getElementById("deliveryPriceBox").style.display = 'flex';
        document.getElementById("deliveryPrice").textContent = delivery.toFixed(2) + " Ø¯ÙŠÙ†Ø§Ø±";
    } else {
        document.getElementById("deliveryPriceBox").style.display = 'none';
    }

    document.getElementById("subtotal").textContent = subtotal.toFixed(2) + " Ø¯ÙŠÙ†Ø§Ø±";
  
    document.getElementById("finalTotal").textContent =
        (subtotal + delivery).toFixed(2) + " Ø¯ÙŠÙ†Ø§Ø±";
}

/* ===== Success Message Functions ===== */
function showSuccessMessage() {
    document.getElementById("successMessage").style.display = "flex";
}

function closeSuccessMessage() {
    document.getElementById("successMessage").style.display = "none";
}

/* ===== Navigation Functions ===== */
function showMenu() {
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('ordersContent').style.display = 'none';
    setActiveNav('menu');
}

function showOrders() {
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('ordersContent').style.display = 'block';
    loadUserOrders();
    setActiveNav('orders');
}

function setActiveNav(active) {
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (active === 'menu') document.getElementById('navMenu').classList.add('active');
    if (active === 'cart') document.getElementById('navCart').classList.add('active');
    if (active === 'orders') document.getElementById('navOrders').classList.add('active');
}

/* ===== Load User Orders ===== */
function loadUserOrders() {
    const ordersList = document.getElementById('ordersList');
    ordersList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ...</div>';

    if (!userPhone) {
        ordersList.innerHTML = `
            <div class="no-amanat">
                <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</h3>
                <p>ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§ØªÙƒ</p>
            </div>
        `;
        return;
    }

    db.ref('orders')
        .orderByChild('userPhone')
        .equalTo(userPhone)
        .once('value', (snapshot) => {
            const orders = snapshot.val();
            ordersList.innerHTML = '';

            if (!orders) {
                ordersList.innerHTML = `
                    <div class="no-amanat">
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</h3>
                        <p>Ù‚Ù… Ø¨Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¢Ù†!</p>
                    </div>
                `;
                return;
            }

            const sortedOrders = Object.keys(orders)
                .map(key => ({ id: key, ...orders[key] }))
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

            sortedOrders.forEach(order => {
                const card = createOrderCard(order);
                ordersList.appendChild(card);
            });
        });
}

/* ===== Create Order Card ===== */
function createOrderCard(order) {
    const card = document.createElement('div');
    card.classList.add('order-card', order.status || 'pending');

    const statusText = {
        'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
        'preparing': 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±',
        'delivering': 'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ',
        'nearby': 'Ù‚Ø±ÙŠØ¨ Ù…Ù†Ùƒ',
        'delivered': 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'
    }[order.status] || order.status;

    const statusClass = {
        'pending': 'status-pending',
        'preparing': 'status-preparing',
        'delivering': 'status-delivering',
        'nearby': 'status-nearby',
        'delivered': 'status-delivered'
    }[order.status] || 'status-pending';

    const date = order.createdAt ? new Date(order.createdAt) : new Date();
    const timeStr = date.toLocaleTimeString('ar-LY', { hour: '2-digit', minute: '2-digit' });
    const dateStr = date.toLocaleDateString('ar-LY');

    const statusOrder = ['pending', 'preparing', 'delivering', 'nearby', 'delivered'];
    const currentIndex = statusOrder.indexOf(order.status);
    const progress = ((currentIndex + 1) / statusOrder.length) * 100;

    const itemsList = order.items ? Object.values(order.items).map(item => 
        `${item.qty} x ${item.name}`
    ).join('ØŒ ') : '';

    let captainHTML = '';
    if (order.captain) {
        captainHTML = `
            <div class="captain-info" style="background: #e3f2fd; padding: 8px 12px; border-radius: 8px; margin: 10px 0; display: flex; align-items: center; gap: 10px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2">
                    <circle cx="12" cy="8" r="4"/>
                    <path d="M5 20v-2a7 7 0 0 1 14 0v2"/>
                </svg>
                <div style="flex:1">
                    <div style="font-weight: 600; color: #0056b3;">Ø§Ù„ÙƒØ§Ø¨ØªÙ†: ${order.captain.name}</div>
                    <div style="font-size: 12px; color: #666;">Ù‡Ø§ØªÙ: ${order.captain.phone}</div>
                    ${order.captain.vehicle ? `<div style="font-size: 12px; color: #666;">Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${order.captain.vehicle}</div>` : ''}
                </div>
            </div>
        `;
    }

    card.innerHTML = `
        <div class="order-header">
            <span class="order-id">Ø·Ù„Ø¨ #${order.id.slice(-6)}</span>
            <span class="order-status ${statusClass}">${statusText}</span>
        </div>
        <div class="order-items">
            <strong>Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</strong> ${itemsList}
        </div>
        <div class="order-total">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
            <span>${order.finalTotal || 0} Ø¯ÙŠÙ†Ø§Ø±</span>
        </div>
        ${captainHTML}
        <div class="tracking-bar">
            <div class="tracking-line">
                <div class="tracking-line-fill" style="width: ${progress}%"></div>
            </div>
            <div class="tracking-step ${currentIndex >= 0 ? 'active' : ''}">
                <div class="step-dot"></div>
                <span>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>
            </div>
            <div class="tracking-step ${currentIndex >= 1 ? 'active' : ''}">
                <div class="step-dot"></div>
                <span>Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</span>
            </div>
            <div class="tracking-step ${currentIndex >= 2 ? 'active' : ''}">
                <div class="step-dot"></div>
                <span>ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</span>
            </div>
            <div class="tracking-step ${currentIndex >= 3 ? 'active' : ''}">
                <div class="step-dot"></div>
                <span>Ù‚Ø±ÙŠØ¨ Ù…Ù†Ùƒ</span>
            </div>
            <div class="tracking-step ${currentIndex >= 4 ? 'active' : ''}">
                <div class="step-dot"></div>
                <span>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>
            </div>
        </div>
        <div style="font-size: 12px; color: var(--muted); text-align: left; margin-top: 10px;">
            ${timeStr} - ${dateStr}
        </div>
    `;

    return card;
}

/* ===== Place Order ===== */
document.getElementById("placeOrder").onclick = ()=>{
    if(Object.keys(cart).length===0){
        alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");
        return;
    }
  
    const orderNotes = document.getElementById("orderNotes").value.trim();
    const orderType = document.getElementById("orderType").value;
    const paymentType = document.getElementById("paymentType").value;
    const area = document.getElementById("headerAreaSelect").value;
  
    if(orderType === "delivery" && !area) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© (Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©) Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„.");
        document.getElementById("headerAreaSelect").focus();
        return;
    }
  
    let subtotal = 0;
    const cartItems = Object.values(cart).map(i => {
        subtotal += i.price * i.qty;
        return `${i.qty} x ${i.name} (${i.price.toFixed(2)} Ø¯)`;
    });

    function getDeliveryPrice(areaName) {
        const area = Object.values(allAreas).find(a => a.name === areaName);
        return area ? area.price : 0;
    }

    let delivery = 0;
    if(orderType === "delivery" && area) {
        delivery = getDeliveryPrice(area) || 0;
    }
    const finalTotal = subtotal + delivery;

    const orderId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    
    const orderData = {
        userPhone: userPhone,
        userArea: area,
        items: cart,
        subtotal: subtotal,
        delivery: delivery,
        finalTotal: finalTotal,
        orderType: orderType,
        paymentType: paymentType,
        notes: orderNotes,
        location: selectedLocation,
        locationAddress: selectedLocation ? document.getElementById('locationAddress').textContent : null,
        status: 'pending',
        statusText: 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        restaurantWhatsapp: RESTAURANT_WHATSAPP,
        captainStatus: 'available' // Ù„Ù„ÙƒØ¨Ø§ØªÙ†: Ø§Ù„Ø·Ù„Ø¨ Ù…ØªØ§Ø­ Ù„Ù„Ù‚Ø¨ÙˆÙ„
    };

    db.ref(`orders/${orderId}`).set(orderData)
        .then(() => {
            if (orderType === 'delivery') {
                return db.ref('amanat').push({
                    orderId: orderId,
                    userPhone: userPhone,
                    senderCity: area,
                    receiverCity: area,
                    description: `Ø·Ù„Ø¨ Ù…Ù† Ø¯Ø¬Ø§Ø¬ Ø¨ÙˆØ±Ø¯Ùˆ:\n${cartItems.join('\n')}\nÙ…Ù„Ø§Ø­Ø¸Ø§Øª: ${orderNotes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}`,
                    senderLocation: selectedLocation ? 
                        `https://www.openstreetmap.org/?mlat=${selectedLocation.lat}&mlon=${selectedLocation.lng}#map=15/${selectedLocation.lat}/${selectedLocation.lng}` : 
                        area,
                    senderLat: selectedLocation ? selectedLocation.lat : null,
                    senderLng: selectedLocation ? selectedLocation.lng : null,
                    receiverLocation: selectedLocation ? 
                        `https://www.openstreetmap.org/?mlat=${selectedLocation.lat}&mlon=${selectedLocation.lng}#map=15/${selectedLocation.lat}/${selectedLocation.lng}` : 
                        area,
                    receiverLat: selectedLocation ? selectedLocation.lat : null,
                    receiverLng: selectedLocation ? selectedLocation.lng : null,
                    receiverName: "Ø¹Ù…ÙŠÙ„ Ø¯Ø¬Ø§Ø¬ Ø¨ÙˆØ±Ø¯Ùˆ",
                    receiverPhone: userPhone,
                    total: delivery,
                    items: cartItems,
                    status: 'pending',
                    acceptedBy: null,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
        })
        .then(() => {
            const locationText = selectedLocation ? 
                `Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ù‚ÙŠÙ‚: https://www.openstreetmap.org/?mlat=${selectedLocation.lat}&mlon=${selectedLocation.lng}#map=15/${selectedLocation.lat}/${selectedLocation.lng}\nØ§Ù„Ø¹Ù†ÙˆØ§Ù†: ${document.getElementById('locationAddress').textContent || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}` : 
                'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø¯Ù‚ÙŠÙ‚';
            
            const orderDetails = `
*ğŸŒŸ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø¯Ø¬Ø§Ø¬ Ø¨ÙˆØ±Ø¯Ùˆ ğŸŒŸ*

*ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:*
Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${userPhone}
Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„: ${area || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© (Ø§Ø³ØªÙ„Ø§Ù…)"}
Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø·Ù„Ø¨: ${orderType === 'delivery' ? 'ØªÙˆØµÙŠÙ„' : 'Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ù…Ø·Ø¹Ù…'}
Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${paymentType}

${locationText}

*ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:*
${cartItems.join('\n')}

*ğŸ’° Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒÙ„ÙØ©:*
Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: ${subtotal.toFixed(2)} Ø¯
Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„: ${delivery.toFixed(2)} Ø¯
*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${finalTotal.toFixed(2)} Ø¯ÙŠÙ†Ø§Ø±*

*ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:*
${orderNotes || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª."}
            `.trim();

            const encodedDetails = encodeURIComponent(orderDetails);
            const whatsappURL = `https://wa.me/${RESTAURANT_WHATSAPP}?text=${encodedDetails}`;
            window.open(whatsappURL, '_blank');

            showSuccessMessage();
            cart = {};
            selectedLocation = null;
            document.getElementById('locationCoords').style.display = 'none';
            document.getElementById('locationAddress').style.display = 'none';
            document.getElementById('locationPicker').classList.remove('selected');
            document.getElementById('locationStatus').innerHTML = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¯Ù‚ÙŠÙ‚';
            renderCart();
            document.getElementById("orderNotes").value = "";
            document.getElementById("orderType").value = "delivery";
            document.getElementById("cartSheet").classList.remove("open");

            setTimeout(() => {
                showOrders();
            }, 2000);
        })
        .catch(error => {
            console.error('Error placing order:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        });
};

/* ===== Back Button Handling ===== */
window.onpopstate = function(event) {
    if (event.state && event.state.page === 'landing') {
        document.getElementById('mainHeader').style.display = 'none';
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('bottomNav').style.display = 'none';
        document.getElementById('landingPage').style.display = 'grid';
        isBrowseMode = false;
    } else if (event.state && (event.state.page === 'browse' || event.state.page === 'order')) {
        document.getElementById('landingPage').style.display = 'none';
        document.getElementById('mainHeader').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('bottomNav').style.display = 'flex';
        document.getElementById('ordersContent').style.display = 'none';
        if(event.state.page === 'order') {
            document.getElementById('areaSelectBox').classList.remove('hidden');
            document.getElementById('searchBoxContainer').classList.remove('full-width');
        } else {
            document.getElementById('areaSelectBox').classList.add('hidden');
            document.getElementById('searchBoxContainer').classList.add('full-width');
        }
    }
};
</script>
</body>
</html>